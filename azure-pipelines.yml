# Docker
# Build a Docker image
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

trigger:
  - development

resources:
  - repo: self

variables:
  tag: '$(Build.BuildId)'
  dockerhubNS: 'gagneet'
  ImageNames: 'adherelive'
  ImageTag: 'portal_demo'
  azureSubscriptionEndpoint: 'AdhereLive'
  azureSubscriptionId: 'AdhereLive'
  azureContainerRegistry: 'adherelivedemo.azurecr.io'
  firstArg: 'build'
  secondArg: 'node'

stages:
  - stage: Build
    displayName: Build image
    jobs:
      - job: Build
        displayName: Build
        pool:
          vmImage: ubuntu-latest
        steps:
          - task: DockerCompose@0
            displayName: Build services
            inputs:
              action: Build services
              azureSubscriptionEndpoint: $(azureSubscriptionEndpoint)
              azureContainerRegistry: $(azureContainerRegistry)
              dockerComposeFile: $(Build.SourceDirectory)/docker-compose.yml
              projectName: $(Build.Repository.Name)
              qualifyImageNames: true
              additionalImageTags: $(Build.BuildId)
              dockerComposeFileArgs: |
                firstArg=$(firstArg)
                secondArg=$(secondArg)
          - task: DockerCompose@0
            displayName: Push services
            inputs:
              action: Push services
              azureSubscriptionEndpoint: $(azureSubscriptionEndpoint)
              azureContainerRegistry: $(azureContainerRegistry)
              dockerComposeFile: $(Build.SourceDirectory)/docker-compose.yml
              projectName: $(Build.Repository.Name)
              qualifyImageNames: true
              additionalImageTags: $(Build.BuildId)
              